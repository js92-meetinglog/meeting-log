name: Spring Boot CI/CD to AWS EC2

# 1. 트리거: 'main' 브랜치에 Push가 발생하면 실행
on:
  push:
    branches: [ "main" ]

jobs:
  # --------------------
  # 1. CI (빌드) 작업
  # --------------------
  build:
    runs-on: ubuntu-latest # 빌드 환경
    
    steps:
      # (1) 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # (2) JDK 21 설치
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # (3) Gradle 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # (4) Gradle로 빌드 (이때 application-local.properties는 사용되지 않음)
      - name: Build with Gradle
        run: ./gradlew build -x test

      # (5) 빌드된 .jar 파일을 'artifact'로 패키징
      #     (다음 deploy 작업에서 사용하기 위해)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar # 아티팩트 이름
          path: build/libs/*.jar # 빌드된 jar 파일 경로

  # --------------------
  # 2. CD (배포) 작업
  # --------------------
  deploy:
    needs: build # 'build' 작업이 성공해야만 실행됨
    runs-on: ubuntu-latest
    
    steps:
      # (1) 'build' 작업에서 만든 'app-jar' 아티팩트 다운로드
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: build/libs # 다운로드 받을 경로

      # (2) EC2 서버로 .jar 파일 전송 (SCP)
      - name: SCP to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "build/libs/*.jar"   # (1)에서 다운로드한 .jar 파일
          target: "/home/ubuntu/app"    # (2단계)에서 EC2에 만들어둔 디렉터리

      # (3) EC2 서버에 접속(SSH)하여 배포 스크립트 실행
      - name: SSH into EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          
          # (중요) EC2 서버에서 실행할 명령어들
          script: |
            export DB_URL=${{ secrets.DB_URL }}
            export DB_USERNAME=${{ secrets.DB_USERNAME }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            # 2. 배포 디렉터리로 이동
            cd /home/ubuntu/app

            # 3. 기존에 실행 중이던 Java 프로세스(서버) 종료
            PID=$(pgrep -f "java -jar")
            if [ -n "$PID" ]; then
              echo "Stopping existing server (PID: $PID)"
              kill -15 $PID || true
              sleep 10
            fi

            # 4. 새 .jar 파일 이름 찾기
            JAR_FILE=$(find . -name "*.jar" | head -n 1)
            
            # 5. 새 .jar 파일을 백그라운드로 실행 (로그 파일 포함)
            echo "Starting new server: $JAR_FILE"
            nohup java -jar $JAR_FILE > /home/ubuntu/app/server.log 2>&1 &